{% include "index.html" %}

{% block content %}

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col md:flex-row gap-4 mb-10">
        <div class="relative flex-1">
            <form id="filter-form" class="flex flex-col md:flex-row gap-4 mb-10 items-center text-black">
                <div class="relative flex-grow w-full md:w-auto">
                    <input type="text" id="search-input" name="search" placeholder="Search books by keyword..."
                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </div>

                <div class="flex gap-4 w-full md:w-auto">
                    <select id="genre-filter" name="genre"
                        class="py-3 px-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm w-full">
                        <option value="">All Genres</option>
                        {% for genre in all_genres %}
                        <option value="{{ genre.pk }}">{{ genre.genre_name }}</option>
                        {% endfor %}
                    </select>
                    <select id="language-filter" name="language"
                        class="py-3 px-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm w-full">
                        <option value="">All Languages</option>
                        {% for lang in all_languages %}
                        <option value="{{ lang.pk }}">{{ lang.language_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div class="flex justify-center items-center mt-10 space-x-2">
        <div id="book-grid-container">
            {% include "partials/book_grid_content.html" %}
        </div>
    </div>
    </div>
</main>

<div id="requestModal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50"
    style="display: none;">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Confirm Your Request</h2>
        <p class="text-gray-700 mb-2">Are you sure you want to request the following book?</p>

        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 id="modalBookTitle" class="text-lg font-semibold text-gray-900"></h3>
            <p id="modalBookAuthor" class="text-sm text-gray-600"></p>
        </div>

        <div id="modalMessage" class="hidden text-sm font-medium mb-4"></div>

        <div class="flex justify-end space-x-3">
            <button id="modalCancelBtn"
                class="px-6 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </button>
            <button id="modalConfirmBtn" data-book-id=""
                class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                Confirm Request
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const genreFilter = document.getElementById('genre-filter');
        const languageFilter = document.getElementById('language-filter');
        const bookGridContainer = document.getElementById('book-grid-container');

        let debounceTimeout;
        async function fetchBooks(page = 1) {
            const searchQuery = searchInput.value;
            const genreId = genreFilter.value;
            const languageId = languageFilter.value;

            const params = new URLSearchParams({
                search: searchQuery,
                genre: genreId,
                language: languageId,
                page: page
            });

            const url = `{% url 'filter_books' %}?${params.toString()}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                bookGridContainer.innerHTML = data.books_html;
            } catch (error) {
                console.error('Error fetching books:', error);
                bookGridContainer.innerHTML = '<p class="col-span-full text-center text-red-500">An error occurred while searching. Please try again.</p>';
            }
        }


        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                fetchBooks(1);
            }, 300);
        });

        genreFilter.addEventListener('change', () => fetchBooks(1));
        languageFilter.addEventListener('change', () => fetchBooks(1));

        paginationContainer.addEventListener('click', function (event) {
            if (event.target.closest('.pagination-link')) {
                event.preventDefault();

                const link = event.target.closest('.pagination-link');
                const url = new URL(link.href);
                const page = url.searchParams.get('page');

                if (page) {
                    const currentUrl = new URL(window.location);
                    currentUrl.searchParams.set('page', page);
                    window.history.pushState({}, '', currentUrl);

                    fetchBooks(page);
                }
            }
        });
    });
</script>
{% endblock %}