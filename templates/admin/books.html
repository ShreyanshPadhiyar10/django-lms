{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}

<div class="flex-1 ml-0 md:ml-64 main-content-scroll bg-gray-50">

    <!-- Top Nav/Header for Mobile (Important for responsiveness) -->
    <header class="md:hidden sticky top-0 bg-white shadow-md p-4 flex justify-between items-center z-10">
        <button class="text-gray-600 hover:text-blue-700">
            <!-- Menu Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" x2="21" y1="12" y2="12" />
                <line x1="3" x2="21" y1="6" y2="6" />
                <line x1="3" x2="21" y1="18" y2="18" />
            </svg>
        </button>
        <span class="text-lg font-semibold text-gray-900">Library Admin</span>
        <button class="text-gray-600 hover:text-blue-700">
            <!-- User Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
            </svg>
        </button>
    </header>
    <main class="p-4 md:p-8">

        <h1 class="text-3xl font-bold text-gray-900 mb-1">Book Catalog</h1>
        <p class="text-gray-500 mb-8">Browse and search our collection</p>

        <form id="filter-form" class="flex flex-col md:flex-row gap-4 mb-10 items-center text-black">
            <div class="relative flex-grow w-full md:w-auto">
                <input type="text" id="search-input" name="search" placeholder="Search books by keyword..."
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
            </div>

            <div class="flex gap-4 w-full md:w-auto">
                <select id="genre-filter" name="genre"
                    class="py-3 px-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm w-full">
                    <option value="">All Genres</option>
                    {% for genre in all_genres %}
                    <option value="{{ genre.pk }}">{{ genre.genre_name }}</option>
                    {% endfor %}
                </select>
                <select id="language-filter" name="language"
                    class="py-3 px-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm w-full">
                    <option value="">All Languages</option>
                    {% for lang in all_languages %}
                    <option value="{{ lang.pk }}">{{ lang.language_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>

        <h2 class="text-2xl font-bold text-gray-800 mb-6">View Books</h2>

        <div id="book-grid-container">
            {% include "partials/book_grid_content.html" %}
        </div>
    </main>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get references to all the interactive elements
        const searchInput = document.getElementById('search-input');
        const genreFilter = document.getElementById('genre-filter');
        const languageFilter = document.getElementById('language-filter');
        const bookGrid = document.getElementById('book-grid');
        const paginationContainer = document.getElementById('pagination-container');
        const bookGridContainer = document.getElementById('book-grid-container');

        // A timer to prevent making a request on every single keystroke (debounce)
        let debounceTimeout;
        // This is the main function that fetches updated book data from the server
        async function fetchBooks(page = 1) {
            const searchQuery = searchInput.value;
            const genreId = genreFilter.value;
            const languageId = languageFilter.value;

            // Build the URL with the current filter values as query parameters
            const params = new URLSearchParams({
                search: searchQuery,
                genre: genreId,
                language: languageId,
                page: page
            });

            // The URL points to the `filter_books` API view you created
            const url = `{% url 'filter_books' %}?${params.toString()}`;

            try {
                // Use the Fetch API to make an asynchronous request to the server
                const response = await fetch(url);
                // Parse the JSON response, which contains the new HTML
                const data = await response.json();

                // Replace the content of the grid and pagination containers with the new HTML

                bookGridContainer.innerHTML = data.books_html;
                paginationContainer.innerHTML = data.pagination_html;
            } catch (error) {
                console.error('Error fetching books:', error);
                bookGrid.innerHTML = '<p class="col-span-full text-center text-red-500">An error occurred while searching. Please try again.</p>';
            }
        }

        // --- EVENT LISTENERS ---

        // 1. Listen for typing in the search bar
        searchInput.addEventListener('input', () => {
            // Clear any existing timer
            clearTimeout(debounceTimeout);
            // Set a new timer. The fetchBooks function will only run after the user stops typing for 300ms.
            debounceTimeout = setTimeout(() => {
                fetchBooks(1); // Always reset to page 1 for a new search
            }, 300);
        });

        // 2. Listen for a change in the dropdown filters
        genreFilter.addEventListener('change', () => fetchBooks(1));
        languageFilter.addEventListener('change', () => fetchBooks(1));

        // 3. Listen for clicks on pagination links using event delegation
        paginationContainer.addEventListener('click', function (event) {
            // Check if the clicked element has the 'pagination-link' class
            if (event.target.closest('.pagination-link')) {
                event.preventDefault(); // Stop the browser from doing a full page reload

                // Get the page number from the link's href attribute
                const link = event.target.closest('.pagination-link');
                const url = new URL(link.href);
                const page = url.searchParams.get('page');

                // Fetch the books for that specific page if a page number is found
                if (page) {
                    fetchBooks(page);
                }
            }
        });
    });
</script>
{% endblock %}